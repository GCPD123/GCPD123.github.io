<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">把无穷无尽握于手掌，永恒宁非是刹那时光</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/07/fastDFS-Nginx%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/blogImg/6711866_014214_8838.jpg">
      <meta itemprop="name" content="XXX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/07/fastDFS-Nginx%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/" class="post-title-link" itemprop="url">fastDFS+Nginx图片上传下载</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-02-07 17:48:05 / 修改时间：22:40:27" itemprop="dateCreated datePublished" datetime="2020-02-07T17:48:05+08:00">2020-02-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%84%9A%E6%89%8B%E6%9E%B6/" itemprop="url" rel="index">
                    <span itemprop="name">脚手架</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="FastDFS"><a href="#FastDFS" class="headerlink" title="FastDFS"></a>FastDFS</h3><blockquote>
<p>FastDFS是是一个轻量级、高性能的开源分布式文件系统，用纯C语言开发，包括文件存储、文件同步、文件访问（上传、下载）、存取负载均衡、在线扩容、相同内容只存储一份等功能，适合有大容量存储需求的应用或系统。</p>
</blockquote>
<h3 id="FastDFS安装"><a href="#FastDFS安装" class="headerlink" title="FastDFS安装"></a>FastDFS安装</h3><p><code>/u01/app</code>: 软件安装位置<br><code>/u01/soft</code>: 软件包位置</p>
<p>安装FastDFS之前先要安装环境libfastcommon，libfastcommon是从 FastDFS 和 FastDHT 中提取出来的公共 C 函数库，基础环境</p>
<h4 id="libfastcommon下载"><a href="#libfastcommon下载" class="headerlink" title="libfastcommon下载"></a>libfastcommon下载</h4><p>当前目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/happyfish100/libfastcommon.git</span><br><span class="line">cd libfastcommon</span><br><span class="line">git checkout V1.0.43</span><br><span class="line">./make.sh clean &amp;&amp; ./make.sh &amp;&amp; ./make.sh install</span><br></pre></td></tr></table></figure>

<p>当前若没有libfastcommon目录，使用git后会自动创建该目录，并将内容克隆进去，这样环境就安装完成</p>
<h4 id="FastDFS下载"><a href="#FastDFS下载" class="headerlink" title="FastDFS下载"></a>FastDFS下载</h4><p>当前目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/happyfish100/fastdfs.git</span><br><span class="line">cd fastdfs</span><br><span class="line">git checkout V6.06</span><br><span class="line">./make.sh clean &amp;&amp; ./make.sh &amp;&amp; ./make.sh install</span><br></pre></td></tr></table></figure>



<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>安装完成后会生成相应的文件与目录</p>
<ol>
<li>服务脚本</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/<span class="keyword">init</span>.d/fdfs_storaged</span><br><span class="line">/etc/<span class="keyword">init</span>.d/fdfs_tracke</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置文件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/fdfs/client.conf.sample</span><br><span class="line">/etc/fdfs/storage.conf.sample</span><br><span class="line">/etc/fdfs/tracker.conf.sample</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>命令工具，/usr/bin目录下</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">./fdfs_upload_appender</span><br><span class="line">./fdfs_download_file</span><br><span class="line">./fdfs_appender_test1</span><br><span class="line">./fdfs_trackerd</span><br><span class="line">./fdfs_storaged</span><br><span class="line">./fdfs_test1</span><br><span class="line">./fdfs_appender_test</span><br><span class="line">./fdfs_upload_file</span><br><span class="line">./fdfs_test</span><br><span class="line">./fdfs_file_info</span><br><span class="line">./fdfs_crc32</span><br><span class="line">./fdfs_monitor</span><br><span class="line">./fdfs_append_file</span><br><span class="line">./fdfs_delete_file</span><br></pre></td></tr></table></figure>



<h4 id="配置FastDFS跟踪器（Tracker）"><a href="#配置FastDFS跟踪器（Tracker）" class="headerlink" title="配置FastDFS跟踪器（Tracker）"></a>配置FastDFS跟踪器（Tracker）</h4><p>/etc/fdfs目录下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp tracker.conf.sample tracker.conf</span><br></pre></td></tr></table></figure>

<p>修改<code>tracker.conf</code>配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置文件是否不生效，false 为生效</span></span><br><span class="line">disabled=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提供服务的端口</span></span><br><span class="line">port=22122</span><br><span class="line"></span><br><span class="line"><span class="comment"># Tracker 数据和日志目录地址(根目录必须存在,子目录会自动创建)</span></span><br><span class="line">base_path=/home/fastdfs/tracker</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP 服务端口</span></span><br><span class="line">http.server_port=8080</span><br></pre></td></tr></table></figure>

<p>启动tracker服务，并监听</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service fdfs_trackerd start</span><br><span class="line">netstat -unltp|grep fdfs</span><br></pre></td></tr></table></figure>



<h4 id="配置FastDFS存储（Storage）"><a href="#配置FastDFS存储（Storage）" class="headerlink" title="配置FastDFS存储（Storage）"></a>配置FastDFS存储（Storage）</h4><p>/etc/fdfs目录下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp storage.conf.sample storage.conf</span><br></pre></td></tr></table></figure>

<p>修改<code>storage.conf</code>配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置文件是否不生效，false 为生效</span></span><br><span class="line">disabled=<span class="literal">false</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定此 storage server 所在 组(卷)</span></span><br><span class="line">group_name=group1</span><br><span class="line"></span><br><span class="line"><span class="comment"># storage server 服务端口</span></span><br><span class="line">port=23000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 心跳间隔时间，单位为秒 (这里是指主动向 tracker server 发送心跳)</span></span><br><span class="line">heart_beat_interval=30</span><br><span class="line"></span><br><span class="line"><span class="comment"># Storage 数据和日志目录地址(根目录必须存在，子目录会自动生成)</span></span><br><span class="line">base_path=/home/fastdfs/storage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存放文件时 storage server 支持多个路径。这里配置存放文件的基路径数目，通常只配一个目录。</span></span><br><span class="line">store_path_count=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 逐一配置 store_path_count 个路径，索引号基于 0。</span></span><br><span class="line"><span class="comment"># 如果不配置 store_path0，那它就和 base_path 对应的路径一样。</span></span><br><span class="line">store_path0=/home/fastdfs/storage</span><br><span class="line"></span><br><span class="line"><span class="comment"># FastDFS 存储文件时，采用了两级目录。这里配置存放文件的目录个数。 </span></span><br><span class="line"><span class="comment"># 如果本参数只为 N（如： 256），那么 storage server 在初次运行时，会在 store_path 下自动创建 N * N 个存放文件的子目录。</span></span><br><span class="line">subdir_count_per_path=256</span><br><span class="line"></span><br><span class="line"><span class="comment"># tracker_server 的列表 ，会主动连接 tracker_server</span></span><br><span class="line"><span class="comment"># 有多个 tracker server 时，每个 tracker server 写一行 此处地址应该是服务器的外网地址，可以访问到的地址，而不是其他任何地址</span></span><br><span class="line">tracker_server=106.14.192.9:22122</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许系统同步的时间段 (默认是全天) 。一般用于避免高峰同步产生一些问题而设定。</span></span><br><span class="line">sync_start_time=00:00</span><br><span class="line">sync_end_time=23:59</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问端口</span></span><br><span class="line">http.server_port=8888</span><br></pre></td></tr></table></figure>

<p>启动<code>storage</code>服务，并监听</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service fdfs_storaged start</span><br><span class="line">netstat -unltp|grep fdfs</span><br></pre></td></tr></table></figure>



<p>查看Storage和Tracker是否在通信</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/fdfs_monitor /etc/fdfs/storage.conf</span><br></pre></td></tr></table></figure>

<p>ACTIVE说明是在通信</p>
<p>设置开机自启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chkconfig fdfs_storaged on</span><br><span class="line">chkconfig fdfs_trackerd on</span><br></pre></td></tr></table></figure>



<h4 id="上传测试"><a href="#上传测试" class="headerlink" title="上传测试"></a>上传测试</h4><p>/etc/fdfs目录下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp client.conf.sample client.conf</span><br></pre></td></tr></table></figure>

<p>修改<code>client.conf</code>配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Client 的数据和日志目录</span></span><br><span class="line">base_path=/home/fastdfs/client</span><br><span class="line"></span><br><span class="line"><span class="comment"># Tracker端口</span></span><br><span class="line">tracker_server=106.14.192.9:22122</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP端口</span></span><br><span class="line">http.tracker_server_port=80</span><br></pre></td></tr></table></figure>

<p>上传文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/fdfs_upload_file /etc/fdfs/client.conf images.jpg</span><br></pre></td></tr></table></figure>

<p>上传成功后返回文件的ID号group1/M00/00/00/rBEAA1w97zqAERTjAAS5JrxON9k590.jpg</p>
<p>组名  磁盘  2级目录   文件名组成一个ID</p>
<p>致辞FastDFS安装完毕，且能够上传，但是无法下载和通过http访问，必须安装nginx作为服务器以支持http方式访问</p>
<h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><h4 id="安装编译工具及库文件"><a href="#安装编译工具及库文件" class="headerlink" title="安装编译工具及库文件"></a>安装编译工具及库文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc gcc-c++ make libtool zlib zlib-devel openssl openssl-devel pcre pcre-devel</span><br></pre></td></tr></table></figure>

<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><p>只有nginx是无法结合FastDFS一起使用的，必须在nginx中加入fast-nginx-module模块才能使用，而该模块的版本与nginx和fastDFS版本必须要求一致，否则编译不通过这里版本为：libfastcommonV1.0.43 FastDFS V6.06 Nginx1.16.1  fast-nginx-moduleV1.22</p>
<h4 id="下载Nginx"><a href="#下载Nginx" class="headerlink" title="下载Nginx"></a>下载Nginx</h4><p>直接官网下载源码安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.16.1.tar.gz</span><br><span class="line">tar -zxvf nginx-1.16.1.tar.gz -C /usr/local/u01/app/</span><br></pre></td></tr></table></figure>

<p>####下载fast-nginx-module模块</p>
<p>在/usr/local/u01/app/ 目录（将nginx和模块放到同一目录下a）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/happyfish100/fastdfs-nginx-module</span><br><span class="line">cd fastdfs-nginx-module;</span><br><span class="line">git checkout V1.22</span><br></pre></td></tr></table></figure>

<p>至此 模块下载完成，不能单独编译，必须让它加载到nginx中一起编译</p>
<h4 id="编译安装nginx"><a href="#编译安装nginx" class="headerlink" title="编译安装nginx"></a>编译安装nginx</h4><p>进入到nginx的安装目录/usr/local/u01/app/:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx --add-module=../fastdfs-nginx-module/src/</span><br></pre></td></tr></table></figure>

<p>编译安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>查看nginx版本及模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -V</span><br></pre></td></tr></table></figure>

<p>###配置nginx和fastdfs-nginx-module</p>
<p>在/usr/local/u01/app/fastdfs-nginx-module/src<code>目录下复制</code>mod_fastdfs.conf<code>文件到</code>/etc/fdfs目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp mod_fastdfs.conf /etc/fdfs/</span><br></pre></td></tr></table></figure>

<p>在<code>/etc/fdfs</code>目录下修改<code>mod_fastdfs.conf</code>配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">base_path=/home/fastdfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接超时时间</span></span><br><span class="line">connect_timeout=10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Tracker Server 该地址一定要指定 不能是tracker</span></span><br><span class="line">tracker_server=106.14.192.9:22122</span><br><span class="line"></span><br><span class="line"><span class="comment"># StorageServer 默认端口</span></span><br><span class="line">storage_server_port=23000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果文件ID的uri中包含/group**，则要设置为true</span></span><br><span class="line">url_have_group_name = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Storage 配置的store_path0路径，必须和storage.conf中的一致</span></span><br><span class="line">store_path0=/home/fastdfs/storage</span><br></pre></td></tr></table></figure>



<p>在<code>/usr/local/nginx/conf</code>目录下配置nginx，修改<code>nginx.conf</code>文件</p>
<p>必须加到location那一块：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location ~/M00 &#123;</span><br><span class="line">    root /home/fastdfs/storage/<span class="keyword">data</span>;</span><br><span class="line">    ngx_fastdfs_module;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拷贝fasdfs/conf<code>目录下的</code>http.conf、mime.types<code>文件到</code>/etc/fdfs/目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp http.conf mime.types /etc/fdfs/</span><br></pre></td></tr></table></figure>

<p>启动nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>

<p>打开浏览器:<a href="http://106.14.192.9/group1/M00/00/00/xxxxxxxxxxxxxxx.jpg能够访问到说明成功！" target="_blank" rel="noopener">http://106.14.192.9/group1/M00/00/00/xxxxxxxxxxxxxxx.jpg能够访问到说明成功！</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/26/OGNL%E8%A1%A8%E8%BE%BE%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/blogImg/6711866_014214_8838.jpg">
      <meta itemprop="name" content="XXX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/26/OGNL%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="post-title-link" itemprop="url">OGNL表达式</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-26 11:52:47" itemprop="dateCreated datePublished" datetime="2020-01-26T11:52:47+08:00">2020-01-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-02-02 10:33:51" itemprop="dateModified" datetime="2020-02-02T10:33:51+08:00">2020-02-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%A1%A8%E8%BE%BE%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">表达式</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="OGNL表达式"><a href="#OGNL表达式" class="headerlink" title="OGNL表达式"></a>OGNL表达式</h3><p>object graphic navigation language</p>
<p>对象  试图 导航  语言</p>
<p>他是通过对象的取值方法（get方法）来获取数据，在写法上把gey省略掉了，</p>
<p>比如:我们获取用户的名称</p>
<p>类中的写法：user.getUsername();</p>
<p>OGNL表达式写法：user.username   (直接用对象点get方法点后面名称)</p>
<p>mybatis中为什么直接写username，而不用写user.username：因为在parametertype中已经提供了属性所属的类，所以直接写属性名</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.itheima.domain.User"</span>&gt;</span></span><br><span class="line">       update user set username=#&#123;username&#125;,address=#&#123;address&#125;,sex=#&#123;sex&#125;,birthday=#&#123;birthday&#125; where id=#&#123;id&#125;;</span><br><span class="line">   <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h3><p>URL:统一资源定位符，他可以唯一标识一个资源的位置</p>
<p>写法：协议  主机  端口   URI</p>
<p><a href="http://localhost:8080/mybatisserver/demo1Servlet" target="_blank" rel="noopener">http://localhost:8080/mybatisserver/demo1Servlet</a></p>
<p>URI:统一资源标识符 他在应用中可以唯一定位一个资源</p>
<p>在windows系统中URL是file:///xxxxxxx来表示一个文件 file是协议///最后一个/是默认端口号</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/10/%E7%BB%83%E4%B9%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/blogImg/6711866_014214_8838.jpg">
      <meta itemprop="name" content="XXX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/10/%E7%BB%83%E4%B9%A0%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/" class="post-title-link" itemprop="url">练习遇到的问题汇总</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-10 13:48:00" itemprop="dateCreated datePublished" datetime="2020-01-10T13:48:00+08:00">2020-01-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-02-05 15:01:29" itemprop="dateModified" datetime="2020-02-05T15:01:29+08:00">2020-02-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index">
                    <span itemprop="name">java框架</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="练习时候遇到问题"><a href="#练习时候遇到问题" class="headerlink" title="练习时候遇到问题"></a>练习时候遇到问题</h3><ol>
<li>理解项目中的jdk与maven中的jdk：一个项目中依赖的jdk如1.8，则maven编译插件的可选jdk必须小于等于1.8，不能超过该项目的依赖版本,存在一个交叉编译的原理，高的可兼容低的，前提是电脑上必须安装了1.8的jdk。修改如下</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">     &lt;plugins&gt;</span><br><span class="line">         &lt;plugin&gt;</span><br><span class="line">             &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">             &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span><br><span class="line">             &lt;configuration&gt;</span><br><span class="line">                 &lt;source&gt;1.8&lt;/source&gt;</span><br><span class="line">                 &lt;target&gt;1.8&lt;/target&gt;</span><br><span class="line">                 &lt;encoding&gt;UTF-8&lt;/encoding&gt;</span><br><span class="line">             &lt;/configuration&gt;</span><br><span class="line">         &lt;/plugin&gt;</span><br><span class="line">     &lt;/plugins&gt;</span><br><span class="line"> &lt;/build&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>@propertySource与@value注解必须在spring5.0.2中才生效，版本低了比如4.2.4中不生效，而该spring必须要jdk1.8才生效，问题查了很久</li>
<li>spring中事务相关的包有：spring-jdbc（提供了DataSourceTransactionManager类，该类是PlatformTransactionManage的实现类）spring-tx（PlatformTransactionManage接口在该包中）也就是说实现类和接口是在分开的包中的所以都要导入</li>
<li>在写jsp等时候会出现功能不出现的问题，可以先删除源文件重新生成即可</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">"/js/jquery.min.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        <span class="comment">//页面加载 绑定点击按钮事件</span></span><br><span class="line">        $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            $(<span class="string">"#btn"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="comment">// alert("hello btn")</span></span><br><span class="line">                $.ajax(&#123;</span><br><span class="line">                    <span class="comment">//json格式数据</span></span><br><span class="line">                    url:<span class="string">"param/testAjax"</span>,</span><br><span class="line">                    contentType:<span class="string">"application/json;charset=UTF-8"</span>,</span><br><span class="line">                    data:<span class="string">'&#123;"username":"xuefeihuang","password":"555555","money":"77.9"&#125;'</span>,</span><br><span class="line">                    dataType:<span class="string">"json"</span>,</span><br><span class="line">                    type:<span class="string">"post"</span>,</span><br><span class="line">                    success:<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                        <span class="comment">//data是服务器返回的数据</span></span><br><span class="line">                        alert(data)</span><br><span class="line">                        alert(data.username)</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中脚本要先引入，使用的函数都在引入的脚本中，所以要开放该路径，spring前端控制器会拦截所有请求的路径所以开放路径</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;mvc:resources mapping="/js/**" location="/js/"&gt;&lt;/mvc:resources&gt;</span><br></pre></td></tr></table></figure>

<p>mapping是请求路径，location是文件的位置</p>
<ol start="5">
<li>springmvc文件上传功能中，需要导入commons-fileupload第三方文件上传包，然后文件解析器是在spring-web中，也就是说解析和上传在不同的包中完成，且文件解析器id必须是固定名称</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">文件上传包</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;commons-fileupload&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;commons-fileupload&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;1.3.1&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">文件解析包，直接获取文件项，封装到形参中</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-web&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=<span class="string">"multipartResolver"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"org.springframework.web.multipart.commons.CommonsMultipartResolver"</span>&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &lt;property name=<span class="string">"defaultEncoding"</span> value=<span class="string">"UTF-8"</span> /&gt;</span><br><span class="line">        &lt;property name=<span class="string">"maxUploadSize"</span> value=<span class="string">"10240000"</span> /&gt;</span><br><span class="line">        &lt;!-- 设置在文件上传时允许写到内存中的最大值，以字节为单位计算，默认是<span class="number">10240</span> --&gt;</span><br><span class="line">        &lt;!-- 但是经实验，上传文件大小若小于此参数，则不会生成临时文件，故改为<span class="number">2048</span> --&gt;</span><br><span class="line">        &lt;property name=<span class="string">"maxInMemorySize"</span> value=<span class="string">"2048"</span> /&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<p>此id只能叫这个</p>
<ol start="6">
<li>springmvc跨服务器文件上传需要导入两个包</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;com.sun.jersey&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;jersey-core&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;1.18.1&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;com.sun.jersey&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;jersey-client&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;1.18.1&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/testUpload2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testFileUpload2</span><span class="params">( MultipartFile upload)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"跨服务器文件上传"</span>);</span><br><span class="line">        <span class="comment">//获取文件服务器的地址</span></span><br><span class="line">        String path = <span class="string">"http://localhost:9090/fileupload/fileuploads/"</span>;<span class="comment">//注意最后的/后面拼接要用</span></span><br><span class="line">        <span class="comment">//获取上传文件等名称</span></span><br><span class="line">        String filename = upload.getOriginalFilename();</span><br><span class="line">        <span class="comment">//获取随机id</span></span><br><span class="line">        String uuid = UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">//把文件名设置为唯一</span></span><br><span class="line">        filename = uuid + <span class="string">"_"</span> + filename;</span><br><span class="line">        <span class="comment">//创建客户端</span></span><br><span class="line">        Client client = Client.create();</span><br><span class="line">        <span class="comment">//与服务器连接</span></span><br><span class="line">        WebResource resource = client.resource(path + filename);</span><br><span class="line">        <span class="comment">//执行上传</span></span><br><span class="line">        resource.put(upload.getBytes());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其中localhost:9090是文件服务器的地址，练习时可用本机上另一个tomcat代替fileupload时应用名称后面fileuploads时文件夹，也就是该应用下面的文件夹，需要手动创建。<strong>在文件服务器上默认是不允许写入的，需要修改tomcat卸乳权限，但是在本地应用是可以的，就是传到自己的tomcat上</strong>。修改如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.在tomcat的配置文件(tomcat文件夹下的conf/web.xml)里面加上</span><br><span class="line">		&lt;param-name&gt;readonly&lt;/param-name&gt;</span><br><span class="line">		&lt;param-value&gt;false&lt;/param-value&gt;</span><br><span class="line">		注：加在:</span><br><span class="line">		&lt;servlet&gt;</span><br><span class="line">					&lt;init-param&gt;</span><br><span class="line">				            &lt;param-name&gt;debug&lt;/param-name&gt;</span><br><span class="line">				            &lt;param-value&gt;0&lt;/param-value&gt;</span><br><span class="line">							&lt;param-name&gt;readonly&lt;/param-name&gt;</span><br><span class="line">							&lt;param-value&gt;false&lt;/param-value&gt;</span><br><span class="line">	        		&lt;/init-param&gt;</span><br><span class="line">		&lt;/servlet&gt;</span><br><span class="line"><span class="number">2</span>.在项目目录/target/项目目录/添加uploads文件夹</span><br></pre></td></tr></table></figure>

<p>然后重启所有tomcat。</p>
<ol start="7">
<li>Linux安装redis后 客户端无法访问的问题：因为redis默认监听的ip是127.0.0.1我们要修改为监听所有 也就是0.0.0.0 在redis.conf里面修改即可，改后重启服务</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/08/springTransaction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/blogImg/6711866_014214_8838.jpg">
      <meta itemprop="name" content="XXX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/08/springTransaction/" class="post-title-link" itemprop="url">springTransaction</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-01-08 21:27:35 / 修改时间：21:50:34" itemprop="dateCreated datePublished" datetime="2020-01-08T21:27:35+08:00">2020-01-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index">
                    <span itemprop="name">java框架</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="spring中的事务"><a href="#spring中的事务" class="headerlink" title="spring中的事务"></a>spring中的事务</h3><p>spring中的事务都是基于AOP的，spring为我们提供了一组事务的接口，在spring-tx包中，注意是接口定义，其中一个接口是：PlatformTransactionManager，其中一个实现类DataSourceTransactionManager在spring-jdbc包中，所以使用的时候要导入着两个包。</p>
<blockquote>
<p>注意：spring的事务管理只对spring-jdbc包中的JdbcTemplate有用，对QueryRunner都没用</p>
</blockquote>
<h3 id="配置步骤"><a href="#配置步骤" class="headerlink" title="配置步骤"></a>配置步骤</h3><ol>
<li>在bean.xml中导入tx的约束</li>
<li>配置事务管理器也就是DataSourceTransactionManager类，将生成实例放入spring容器中,在配置类中配置</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransctionConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"transactionManager"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">createTransctionManager</span><span class="params">(DataSource dataSource)</span></span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中数据源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.configure;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.ComboPooledDataSource;</span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.DataSources;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.dbutils.QueryRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.PropertySource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.beans.PropertyVetoException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Xue</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/1/7 - 8:46 下午</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;username&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;password&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;url&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;driver&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSource"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">createDataSource</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        ComboPooledDataSource dataSource = <span class="keyword">new</span> ComboPooledDataSource();</span><br><span class="line">           dataSource.setDriverClass(driver);</span><br><span class="line">            dataSource.setUser(username);</span><br><span class="line">            dataSource.setPassword(password);</span><br><span class="line">            dataSource.setJdbcUrl(url);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dataSource;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span>  RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"jdbcTemplate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">createJdbcTemplate</span><span class="params">(DataSource dataSource)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：DataSoureTransactionManager和JdbcTemplate都需要数据源也就是连接池！但是都是spring处理的，所以可以保证都是使用的相同的连接，只有这样才会有事务的控制，所以也就解释了为什么queryRunner无法被这个事务管理器控制，因为连接不相同。</p>
<ol start="3">
<li>在主配置文件中声明事务注解开启，支持事务的注解配置</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.configure;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Xue</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/1/7 - 8:45 下午</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.itheima"</span>)</span><br><span class="line"><span class="meta">@Import</span>(&#123;JdbcConfiguration.class,TransctionConfiguration.class&#125;)</span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"jdbc.properties"</span>)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>可以在想要使用的方法上使用注解来开启事务控制了</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.dao.IAccountDao;</span><br><span class="line"><span class="keyword">import</span> com.itheima.domain.Account;</span><br><span class="line"><span class="keyword">import</span> com.itheima.service.IAccountService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Xue</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/1/7 - 9:01 下午</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span>(<span class="string">"accountService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountService</span> <span class="keyword">implements</span> <span class="title">IAccountService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"accountDao1"</span>)</span><br><span class="line">    <span class="keyword">private</span> IAccountDao accountDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Account&gt; <span class="title">findAllAccount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accountDao.findAllAccount();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Account <span class="title">findAccountById</span><span class="params">(Integer accountId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accountDao.findAccountById(accountId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveAccount</span><span class="params">(Account account)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        accountDao.saveAccount(account);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateAccount</span><span class="params">(Account account)</span> </span>&#123;</span><br><span class="line">        accountDao.updateAccount(account);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAccount</span><span class="params">(Integer accountId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        accountDao.deleteAccount(accountId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(String sourceName, String targetName, Float money)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Account source = accountDao.getAccountByName(sourceName);</span><br><span class="line">        Account target = accountDao.getAccountByName(targetName);</span><br><span class="line">        source.setMoney(source.getMoney()-money);</span><br><span class="line">        target.setMoney(target.getMoney()+money);</span><br><span class="line">        accountDao.updateAccount(source);</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        accountDao.updateAccount(target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="事务的xml配置"><a href="#事务的xml配置" class="headerlink" title="事务的xml配置"></a>事务的xml配置</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 事务管理器 --&gt;</span><br><span class="line">	&lt;bean id=<span class="string">"transactionManager"</span></span><br><span class="line">		<span class="class"><span class="keyword">class</span></span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span><br><span class="line">		&lt;!-- 数据源 --&gt;</span><br><span class="line">		&lt;property name=<span class="string">"dataSource"</span> ref=<span class="string">"dataSource"</span> /&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">	&lt;!-- 通知 --&gt;</span><br><span class="line">	&lt;tx:advice id=<span class="string">"txAdvice"</span> transaction-manager=<span class="string">"transactionManager"</span>&gt;</span><br><span class="line">		&lt;tx:attributes&gt;</span><br><span class="line">			&lt;!-- 传播行为 --&gt;</span><br><span class="line">			&lt;tx:method name=<span class="string">"save*"</span> propagation=<span class="string">"REQUIRED"</span> /&gt;</span><br><span class="line">			&lt;tx:method name=<span class="string">"insert*"</span> propagation=<span class="string">"REQUIRED"</span> /&gt;</span><br><span class="line">			&lt;tx:method name=<span class="string">"add*"</span> propagation=<span class="string">"REQUIRED"</span> /&gt;</span><br><span class="line">			&lt;tx:method name=<span class="string">"create*"</span> propagation=<span class="string">"REQUIRED"</span> /&gt;</span><br><span class="line">			&lt;tx:method name=<span class="string">"delete*"</span> propagation=<span class="string">"REQUIRED"</span> /&gt;</span><br><span class="line">			&lt;tx:method name=<span class="string">"update*"</span> propagation=<span class="string">"REQUIRED"</span> /&gt;</span><br><span class="line">			&lt;tx:method name=<span class="string">"find*"</span> propagation=<span class="string">"SUPPORTS"</span> read-only=<span class="string">"true"</span> /&gt;</span><br><span class="line">			&lt;tx:method name=<span class="string">"select*"</span> propagation=<span class="string">"SUPPORTS"</span> read-only=<span class="string">"true"</span> /&gt;</span><br><span class="line">			&lt;tx:method name=<span class="string">"get*"</span> propagation=<span class="string">"SUPPORTS"</span> read-only=<span class="string">"true"</span> /&gt;</span><br><span class="line">		&lt;/tx:attributes&gt;</span><br><span class="line">	&lt;/tx:advice&gt;</span><br><span class="line">	&lt;!-- 切面 --&gt;</span><br><span class="line">	&lt;aop:config&gt;</span><br><span class="line">		&lt;aop:advisor advice-ref=<span class="string">"txAdvice"</span></span><br><span class="line">			pointcut=<span class="string">"execution(* com.taotao.service.*.*(..))"</span> /&gt;</span><br><span class="line">	&lt;/aop:config&gt;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/05/springAop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/blogImg/6711866_014214_8838.jpg">
      <meta itemprop="name" content="XXX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/05/springAop/" class="post-title-link" itemprop="url">springAop</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-05 22:26:23" itemprop="dateCreated datePublished" datetime="2020-01-05T22:26:23+08:00">2020-01-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-01-10 13:49:13" itemprop="dateModified" datetime="2020-01-10T13:49:13+08:00">2020-01-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index">
                    <span itemprop="name">java框架</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="转账与事务问题"><a href="#转账与事务问题" class="headerlink" title="转账与事务问题"></a>转账与事务问题</h3><p><img src="/2020/01/05/springAop/1.png" alt></p>
<p>转账的代码中调用了4次dao层的方法，而dao层的所有方法都需要使用queryRunner而其中又需要连接数据库的connection类，所有每用到一次dao就要连接一次数据库，如果出现1/0的异常，则之前的操作都提交了事务，此时是有事务的，没有事务则数据库任何操作都不能完成，该事务是自动开启的，默认都是自动开启。异常后面的代码就不会执行了，这就是事务不一致，因为事务是基于连接的，一个连接就是一个事务，一个提交是一个事务，事务不一致就是因为每次调用dao都是一个新的连接，无法统一操作。希望达到的目的是：所有的操作都用一个事务控制，即要成功一起成功，要失败一起失败即回滚操作。要达到此目的首先需要保证所有的操作都用一个数据库连接来完成，由此可以想到的是获取到一个连接之后用容器来保存，后面就都用容器中的连接这个容器就是线程。</p>
<p>目前的问题：需要有一个事务控制的类，在该类中保证连接的唯一性。所以需要transction和connectionutils两个工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ThreadLocal&lt;Connection&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;Connection&gt;();</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Connection connection = threadLocal.get();</span><br><span class="line">        <span class="keyword">if</span>(connection == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connection = dataSource.getConnection();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">            &#125;</span><br><span class="line">            threadLocal.set(connection);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//移除线程上到连接</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeConnection</span><span class="params">()</span></span>&#123;</span><br><span class="line">        threadLocal.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于连接是从连接池中取出的，调用close方法只是将其放回池中，但连接还和线程绑定，所以要和线程解绑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">transctionManager</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConnectionUtils connectionUtils;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    开启事务,先关闭自动提交</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beginTransction</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connectionUtils.getConnection().setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    提交事务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connectionUtils.getConnection().commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    回滚事务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connectionUtils.getConnection().rollback();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    释放连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connectionUtils.getConnection().close();<span class="comment">//还回到连接池,连接还在，只是不可用了，所以要解除绑定</span></span><br><span class="line">            connectionUtils.removeConnection();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了transctionmanager类就可以进行事务控制了，用在每一个与数据库打交道的方法中，增删改需要事务，查询不需要，因为它不改变数据库中的内容。</p>
<p>修改后的业务层代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span>(<span class="string">"accountService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">IAcountService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IAccountDao accountDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> transctionManager tx;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccountDao</span><span class="params">(IAccountDao accountDao)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.accountDao = accountDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Account&gt; <span class="title">findAllAccount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//开启事务</span></span><br><span class="line">            tx.beginTransction();</span><br><span class="line">            <span class="comment">//执行操作</span></span><br><span class="line">            List&lt;Account&gt; allAccount = accountDao.findAllAccount();</span><br><span class="line">            <span class="comment">//提交事务</span></span><br><span class="line">            tx.commit();</span><br><span class="line">            <span class="comment">//返回结果</span></span><br><span class="line">            <span class="keyword">return</span> allAccount;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//回滚事务</span></span><br><span class="line">            tx.rollback();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放连接</span></span><br><span class="line">            tx.release();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Account <span class="title">findAccountById</span><span class="params">(Integer accountId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//开启事务</span></span><br><span class="line">            tx.beginTransction();</span><br><span class="line">            <span class="comment">//执行操作</span></span><br><span class="line">            Account accountById = accountDao.findAccountById(accountId);</span><br><span class="line">            <span class="comment">//提交事务</span></span><br><span class="line">            tx.commit();</span><br><span class="line">            <span class="comment">//返回结果</span></span><br><span class="line">            <span class="keyword">return</span> accountById;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="comment">//异常后回滚</span></span><br><span class="line">            tx.rollback();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放连接</span></span><br><span class="line">            tx.release();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveAccount</span><span class="params">(Account account)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//开启事务</span></span><br><span class="line">            tx.beginTransction();</span><br><span class="line">            <span class="comment">//执行操作</span></span><br><span class="line">            accountDao.saveAccount(account);</span><br><span class="line">            <span class="comment">//提交事务</span></span><br><span class="line">            tx.commit();</span><br><span class="line">            <span class="comment">//返回结果</span></span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="comment">//异常后回滚</span></span><br><span class="line">            tx.rollback();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放连接</span></span><br><span class="line">            tx.release();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateAccount</span><span class="params">(Account account)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//开启事务</span></span><br><span class="line">            tx.beginTransction();</span><br><span class="line">            <span class="comment">//执行操作</span></span><br><span class="line">            accountDao.updateAccount(account);</span><br><span class="line">            <span class="comment">//提交事务</span></span><br><span class="line">            tx.commit();</span><br><span class="line">            <span class="comment">//返回结果</span></span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="comment">//异常后回滚</span></span><br><span class="line">            tx.rollback();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放连接</span></span><br><span class="line">            tx.release();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAccount</span><span class="params">(Integer accountId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//开启事务</span></span><br><span class="line">            tx.beginTransction();</span><br><span class="line">            <span class="comment">//执行操作</span></span><br><span class="line">            accountDao.deleteAccount(accountId);</span><br><span class="line">            <span class="comment">//提交事务</span></span><br><span class="line">            tx.commit();</span><br><span class="line">            <span class="comment">//返回结果</span></span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="comment">//异常后回滚</span></span><br><span class="line">            tx.rollback();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放连接</span></span><br><span class="line">            tx.release();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 一个dao就是一个事务，因为有连接操作数据库，所以就有事务，默认情况下是自动提交的事务</span></span><br><span class="line"><span class="comment">     * 现在的情况是每个dao都有一个单独的连接，所以是独立分开的事务，为了控制事务，所以要统一连接</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sourceName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> money</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(String sourceName, String targetName, Float money)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//开启事务</span></span><br><span class="line">            tx.beginTransction();</span><br><span class="line">            <span class="comment">//获取转出账户</span></span><br><span class="line">            Account sn = accountDao.getAccountByName(sourceName);</span><br><span class="line">            <span class="comment">//获取转入账户</span></span><br><span class="line">            Account tn = accountDao.getAccountByName(targetName);</span><br><span class="line">            <span class="comment">//转出账户减钱</span></span><br><span class="line">            sn.setMoney(sn.getMoney() - money);</span><br><span class="line">            <span class="comment">//转入用户加钱</span></span><br><span class="line"></span><br><span class="line">            tn.setMoney(tn.getMoney() + money);</span><br><span class="line">            <span class="comment">//更新转出账户</span></span><br><span class="line">            accountDao.updateAccount(sn);</span><br><span class="line">              <span class="keyword">int</span> i = <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">            <span class="comment">//更新转入账户</span></span><br><span class="line">            accountDao.updateAccount(tn);</span><br><span class="line">            <span class="comment">//提交事务</span></span><br><span class="line">            tx.commit();</span><br><span class="line">            <span class="comment">//返回结果</span></span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="comment">//异常后回滚</span></span><br><span class="line">            tx.rollback();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放连接</span></span><br><span class="line">            tx.release();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">           </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时业务层的所有方法都有了事务的控制，即要么同时成功，要么同时失败，这时由唯一的连接决定的。但是如此一来每次新增一个方法就要重复写上这些相同的代码，所有为了解决代码的重复性，就有了AOP，面向切面！</p>
<h3 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h3><p>使用代理可以解决重复的代码，代理的意义在于A代理B,则当B的方法执行时，会先执行A中增强的方法。实际上此时代理对象和被代理对象都是实现了同一个约束，所以此时直接用代理对象执行方法就是增强的方法，所以有没有增强还是看对象是代理还是非代理。</p>
<h4 id="常用动态代理分为两类"><a href="#常用动态代理分为两类" class="headerlink" title="常用动态代理分为两类"></a>常用动态代理分为两类</h4><ol>
<li>基于借口的动态代理，使用JDK官方的Proxy类，<strong>要求被代理者至少实现一个接口</strong></li>
<li>基于子类的动态代理，使用第三方的CGLib库，<strong>要求被代理类不能是final类</strong></li>
</ol>
<p>使用基于接口的动态代理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">接口名 新对象名 = (接口名)Proxy.newProxyInstance(</span><br><span class="line">    被代理的对象.getClass().getClassLoader(),	<span class="comment">// 被代理对象的类加载器,固定写法</span></span><br><span class="line">    被代理的对象.getClass().getInterfaces(),	<span class="comment">// 被代理对象实现的所有接口,固定写法</span></span><br><span class="line">    <span class="keyword">new</span> InvocationHandler() &#123;	<span class="comment">// 匿名内部类,通过拦截被代理对象的方法来增强被代理对象</span></span><br><span class="line">        <span class="comment">/* 被代理对象的任何方法执行时,都会被此方法拦截到</span></span><br><span class="line"><span class="comment">        	其参数如下:</span></span><br><span class="line"><span class="comment">                proxy: 代理对象的引用,不一定每次都用得到</span></span><br><span class="line"><span class="comment">                method: 被拦截到的方法对象</span></span><br><span class="line"><span class="comment">                args: 被拦截到的方法对象的参数</span></span><br><span class="line"><span class="comment">        	返回值:</span></span><br><span class="line"><span class="comment">        		被增强后的返回值</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">"方法名"</span>.equals(method.getName())) &#123;</span><br><span class="line">            	<span class="comment">// 增强方法的操作</span></span><br><span class="line">                rtValue = method.invoke(被代理的对象, args);</span><br><span class="line">                <span class="comment">// 增强方法的操作</span></span><br><span class="line">                <span class="keyword">return</span> rtValue;</span><br><span class="line">            &#125;          </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>使用工厂产生代理对象，然后使用增强后的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.service.IAcountService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.service.impl.AccountServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.itheima.utils.transctionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Xue</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/1/2 - 8:13 下午</span></span><br><span class="line"><span class="comment"> * 使用工厂产生代理对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span>  IAcountService accountService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> transctionManager tx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取代理对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"proxyService"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IAcountService <span class="title">getAccountServiceProxy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (IAcountService) Proxy.newProxyInstance(AccountServiceImpl.class.getClassLoader(), AccountServiceImpl.class.getInterfaces()</span><br><span class="line">                , <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * 添加事务的支持</span></span><br><span class="line"><span class="comment">                     * <span class="doctag">@param</span> proxy 代理对象本身也就是proxyService</span></span><br><span class="line"><span class="comment">                     * <span class="doctag">@param</span> method 执行的方法，此处是用了反射，将被代理对象中的方法提取出来</span></span><br><span class="line"><span class="comment">                     * <span class="doctag">@param</span> args 执行方法时候的参数</span></span><br><span class="line"><span class="comment">                     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">                     * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                        Object invoke = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">//开启事务</span></span><br><span class="line">                            tx.beginTransction();</span><br><span class="line">                            <span class="comment">//执行操作</span></span><br><span class="line">                            System.out.println(<span class="string">"代理对象方法运行了"</span>);</span><br><span class="line">                             invoke = method.invoke(accountService, args);</span><br><span class="line">                            <span class="comment">//提交事务</span></span><br><span class="line">                            tx.commit();</span><br><span class="line">                            <span class="comment">//返回结果</span></span><br><span class="line">                            <span class="keyword">return</span> invoke;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            <span class="comment">//回滚事务</span></span><br><span class="line">                            tx.rollback();</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            <span class="comment">//释放连接</span></span><br><span class="line">                            tx.release();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getAccountServiceProxy()方法就是为了获取代理后的对象，顺便在产生的过程中把如何加强被代理对象的方法也确定了，即先执行什么再干什么。其中 invoke = method.invoke(accountService, args);<strong>表示直接执行拦截到的原方法，包括拦截到的方法参数一起执行</strong>，此时要知名执行的对象，因为一个类会有多个对象，各个状态不一样（成员变量）此时的method类是通过反射创建Class对象中成员变量method所以自带invoke方法</p>
<p>测试工厂类产生代理对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(classes = SpringConfiguar.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanFactoryTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BeanFactory factory;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getAccountServiceProxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        factory.getAccountServiceProxy().findAllAccount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以后用代理对象执行即可完成方法的加强，在业务层中只需要业务代码而不需要手动增加事务控制了！</p>
<h3 id="Spring-中的AOP"><a href="#Spring-中的AOP" class="headerlink" title="Spring 中的AOP"></a>Spring 中的AOP</h3><p>####相关术语</p>
<ul>
<li><p><code>Joinpoint</code>(<code>连接点</code>): 被拦截到的方法.</p>
</li>
<li><p><code>Pointcut</code>(<code>切入点</code>): 我们对其进行增强的方法.</p>
</li>
<li><p><code>Advice</code>(<code>通知</code>/<code>增强</code>): 对切入点进行的增强操作</p>
<p>包括<code>前置通知</code>,<code>后置通知</code>,<code>异常通知</code>,<code>最终通知</code>,<code>环绕通知</code></p>
</li>
<li><p><code>Weaving</code>(<code>织入</code>): 是指把增强应用到目标对象来创建新的代理对象的过程。</p>
</li>
<li><p><code>Aspect</code>(<code>切面</code>): 是切入点和通知的结合</p>
</li>
</ul>
<h4 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h4><ol>
<li>引入约束</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">"http://www.springframework.org/schema/beans"</span></span><br><span class="line">       xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">       xmlns:aop=<span class="string">"http://www.springframework.org/schema/aop"</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">"http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/aop</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span><br><span class="line">	</span><br><span class="line">    &lt;!--通知类--&gt;</span><br><span class="line">	&lt;bean id="logger" class="cn.maoritian.utils.Logger"&gt;&lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用<code>标签声明AOP配置,所有关于AOP配置的代码都写在</code>标签内</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;aop:config&gt;</span><br><span class="line">	&lt;!-- AOP配置的代码都写在此处 --&gt;</span><br><span class="line">&lt;/aop:config&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>使用<a href="aop:aspect" target="_blank" rel="noopener">aop:aspect</a>标签配置切面,其属性如下</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;aop:config&gt;</span><br><span class="line">	&lt;aop:aspect id=<span class="string">"logAdvice"</span> ref=<span class="string">"logger"</span>&gt;</span><br><span class="line">    	&lt;!--配置通知的类型要写在此处--&gt;</span><br><span class="line">    &lt;/aop:aspect&gt;</span><br><span class="line">&lt;/aop:config&gt;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用<a href="aop:pointcut" target="_blank" rel="noopener">aop:pointcut</a>标签配置切入点表达式,指定对哪些方法进行增强,其属性如下<ul>
<li><code>id</code>: 指定切入点表达式的<code>id</code></li>
<li><code>expression</code>: 指定切入点表达式</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/24/mysql%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/blogImg/6711866_014214_8838.jpg">
      <meta itemprop="name" content="XXX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/24/mysql%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">mysql安装</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-24 21:23:39" itemprop="dateCreated datePublished" datetime="2019-12-24T21:23:39+08:00">2019-12-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-02-02 11:14:10" itemprop="dateModified" datetime="2020-02-02T11:14:10+08:00">2020-02-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Linux上Mysql安装"><a href="#Linux上Mysql安装" class="headerlink" title="Linux上Mysql安装"></a>Linux上Mysql安装</h3><ol>
<li>下载并安装mysql官方的yum Repository</li>
</ol>
<p>在Linux中yum就是包管理软件，可以用来安装各种软件并解决各种依赖，<strong>yum的下载软件的地方称作yum源</strong>，软件的来源，是在/etc/yum.repose.d/目录中</p>
<p><img src="/2019/12/24/mysql%E5%AE%89%E8%A3%85/1.png" alt></p>
<p>这些repo文件中就是记录了软件下载的来源，不同软件下载来源肯定不一样，所以在软件的官网都会提供yum源来下载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -i -c http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</span><br></pre></td></tr></table></figure>

<p>下载的是yum源文件，还要安装到本地，才能用该源去下载mysql</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mysql57-community-release-el7-10.noarch.rpm</span><br></pre></td></tr></table></figure>

<p>安装mysql服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mysql-community-server</span><br></pre></td></tr></table></figure>

<p>此时下载安装的mysql就是从yum源中的地址来的</p>
<ol start="2">
<li>mysql数据库设置</li>
</ol>
<p>启动MySQL</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start  mysqld.service</span><br></pre></td></tr></table></figure>

<p>查看MySQL运行状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status mysqld.service</span><br></pre></td></tr></table></figure>

<p><strong>此时MySQL已经开始正常运行，需要找出root的密码</strong></p>
<p>因为初始化的mysql是随机密码必须先登陆才能修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep "password" /var/log/mysqld.log</span><br></pre></td></tr></table></figure>

<p>如下命令登录mysql</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br></pre></td></tr></table></figure>

<p>登陆之后第一件事是修改密码为123456</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set password for root@localhost = password(&apos;123456&apos;);</span><br></pre></td></tr></table></figure>

<p>这时会提示密码过于简单无法创建，需要需改创建密码规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set global validate_password_policy=0;</span><br><span class="line">set global validate_password_length=1;</span><br></pre></td></tr></table></figure>

<p>然后就可以正常设置了</p>
<p>解决远程登陆问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#任何主机</span><br><span class="line">mysql&gt;GRANT ALL PRIVILEGES ON *.* TO &apos;root&apos;@&apos;%&apos; IDENTIFIED BY &apos;123456&apos; WITH GRANT OPTION;</span><br><span class="line"></span><br><span class="line">#指定主机</span><br><span class="line">mysql&gt;GRANT ALL PRIVILEGES ON *.* TO &apos;jack&apos;@’10.10.50.127’ IDENTIFIED BY &apos;654321&apos; WITH GRANT OPTION;</span><br><span class="line"></span><br><span class="line"># 然后刷新权限</span><br><span class="line">mysql&gt;flush privileges;</span><br></pre></td></tr></table></figure>



<p>为了支持中文需要修改编码为utf-8</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">port=3306</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">user=mysql</span><br><span class="line"><span class="meta">#</span><span class="bash"> Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line">character-set-server=utf8</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">no-auto-rehash</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error=/var/log/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br></pre></td></tr></table></figure>

<p>重启mysql服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysqld restart</span><br></pre></td></tr></table></figure>

<p>查看数据库编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &apos;character_set%&apos;;</span><br></pre></td></tr></table></figure>

<h3 id="使用客户端工具导入较大sql文件"><a href="#使用客户端工具导入较大sql文件" class="headerlink" title="使用客户端工具导入较大sql文件"></a>使用客户端工具导入较大sql文件</h3><p>出现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 2006 (HY000): MySQL server has gone away</span><br></pre></td></tr></table></figure>

<p>表示文件过大，而缓存区太小，无法成功导入，所以需要扩大缓存</p>
<p>查看通信缓冲区的最大长度：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'max_allowed_packet'</span>;</span><br></pre></td></tr></table></figure>

<p>默认最大是1M，可以修改通信缓冲区的最大长度，修改为16M:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> max_allowed_packet=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">16</span>;</span><br></pre></td></tr></table></figure>

<p>注：修改只对当前有效， 重启了MySQL他就还是会恢复原来的大小。如果是想永久生效，可以修改配置文件，在my.ini（windows下）或者my.cnf（linux下）加入或修改配置 （再最前面添加 后面不成功）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_allowed_packet = 16M</span><br></pre></td></tr></table></figure>

<p>重启MySQL服务…</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/22/springIoc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/blogImg/6711866_014214_8838.jpg">
      <meta itemprop="name" content="XXX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/22/springIoc/" class="post-title-link" itemprop="url">springIoc</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-22 11:06:15" itemprop="dateCreated datePublished" datetime="2019-12-22T11:06:15+08:00">2019-12-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-01-02 21:38:25" itemprop="dateModified" datetime="2020-01-02T21:38:25+08:00">2020-01-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index">
                    <span itemprop="name">java框架</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="工厂类"><a href="#工厂类" class="headerlink" title="工厂类"></a>工厂类</h2><p>工厂类主要解决类之间的依赖问题，只是减少依赖而不能完全消除，一个工厂首先要能生产类（根据配置文件创建出类）然后在根据用户需要获取出类（根据唯一名称获取出相关类）</p>
<ol>
<li><p>首先要有配置文件，就是告诉工厂首先要生产（通过反射创建）出什么类</p>
<p><img src="/2019/12/22/springIoc/1.png" alt></p>
<p>properties类专门加载配置文件，通过类加载器的getResourceAsStream()方法可以直接加载类路径下的配置文件，作为输入流，所谓类路径实际就是<strong>编译后目标文件的</strong>目录结构中的根目录</p>
<p><img src="/2019/12/22/springIoc/2.png" alt></p>
<p>classes就是类路径的根目录也就是说源代码中src和resources目录下所有内容都会原封不动的进入类路径中所以放在resources目录下的配置文件就相当于在编译后的类路径下</p>
<p>因为加载配置文件是在工厂类一运行后就加载一次，所以放在静态代码块中最好，静态代码块随着类的加载而运行，且只运行一次，<strong>注意：静态代码块只能引用静态变量，因为只有静态才在同一个时间加载</strong></p>
</li>
<li><p>加载配置文件后就可以创建获取对象的方法，通过传入相应的唯一id来通过反射创建对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> object <span class="title">getBean</span><span class="params">(String beanName)</span></span>&#123;</span><br><span class="line">  String beanPath = properties.getPropery(beanName);</span><br><span class="line">  object bean = Class.forName(beanPath).newInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是根据唯一id从配置文件中取出该类的全限定类名，然后通过反射创建对象。</p>
</li>
</ol>
<h3 id="工厂类升级"><a href="#工厂类升级" class="headerlink" title="工厂类升级"></a>工厂类升级</h3><p>上面工厂类的不足：每次通过读取配置文件得出类名然后通过反射创建的对象是多例的，也就是每次对象不一样</p>
<p>解决方法：将创建出来的对象保存起来，需要用的时候直接拿出来，这就需要用到一个“容器”来存储对象，也就是spring的核心容器（实际是一个map集合）</p>
<p><img src="/2019/12/22/springIoc/3.png" alt></p>
<p>静态代码块中要做的是</p>
<ol>
<li>创建配置文件对象和集合对象</li>
<li>读取配置文件，将所有类加载</li>
</ol>
<p><img src="/2019/12/22/springIoc/4.png" alt></p>
<p>将所有的key取出来，一个一个的通过反射创建对象，然后存储到map中</p>
<p>然后方法中要做的</p>
<p><img src="/2019/12/22/springIoc/5.png" alt></p>
<p>从map中取出来即可，特点是：工厂类一加载就会将配置文件中的所有类都通过反射创建出来然后存储到map中，也就是说是提前加载，不管你需不需要，然后需要的类直接从map中取出来，就不用通过配置文件了，这样对象就只创建了一次，也就保证了唯一性</p>
<h3 id="springIoc"><a href="#springIoc" class="headerlink" title="springIoc"></a>springIoc</h3><p>springIoc即是spring的核心容器，他是存储配置文件中所有类的容器，在容器中创建对象，然后直接向容器中索取对象</p>
<p>首先通过maven创建spring工程依赖：</p>
<p><img src="/2019/12/22/springIoc/6.png" alt></p>
<p><img src="/2019/12/22/springIoc/7.png" alt></p>
<p>其中aop是注解需要的类</p>
<p>配置文件就相当于工厂中的properties</p>
<p><img src="/2019/12/22/springIoc/8.png" alt></p>
<p>配置的<bean>标签中的内容就是自动创建并且存储到容器中的类，需要的话直接从容器中取出即可</bean></p>
<blockquote>
<p>该标签中的类会通过反射创建，且是通过该类的空参造方法创建，如果没有空参构造方法，则创建失败会报错</p>
</blockquote>
<p><img src="/2019/12/22/springIoc/9.png" alt></p>
<p>通过ApplicationContext对象来获取容器，其中实现类的作用是读取类路径下的配置文件，<strong>配置文件一读取，则spring容器就会初始化，其中所有的类都会自动创建且存入核心容器中</strong></p>
<h3 id="创建bean的三种方式"><a href="#创建bean的三种方式" class="headerlink" title="创建bean的三种方式"></a>创建bean的三种方式</h3><ol>
<li>通过<bean>标签创建，该标签的意思是将class属性中的类通过反射创建该类，然后存入到容器中，使用的时候通过id属性取出来<strong>注意，是使用该类的空参构造方法创建</strong>，如果没有空参构造方法则创建失败</bean></li>
</ol>
<p><img src="/2019/12/22/springIoc/10.png" alt></p>
<ol start="2">
<li>通过普通工厂创建，有些类是在jar包中别人写好的类都是字节码文件无法修改，也不确定有没有默认构造函数，也就不能通过<bean>的方式创建，无法通过配置的方法创建并存入容器，就可以通过一个工厂类，手动创建该需要的类</bean></li>
</ol>
<p><img src="/2019/12/22/springIoc/12.png" alt></p>
<p><img src="/2019/12/22/springIoc/11.png" alt></p>
<p>通过指定工厂的类和方法来创建对象，但是首先要把工厂类存入容器，然后配置需要的类，告诉容器应该如何创建（通过工厂类的一个方法创建，并存入容器中）</p>
<ol start="3">
<li>上面工厂类中的方法可能是静态方法，使用某个类中的静态方法创建对象，并存入容器</li>
</ol>
<p><img src="/2019/12/22/springIoc/13.png" alt></p>
<p><img src="/2019/12/22/springIoc/14.png" alt></p>
<p>前两个属性的意思是：创建staticFactory类，以accountService名字存入容器，但是我们需要的AccountService类的对象，所以要告诉该工厂通过静态方法创建出该类然后存入容器</p>
<h3 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h3><p>两个类之间的依赖，比如在A类中有age name date三个成员变量，这三个就称为依赖，因为如果没有这三个，则该类不完整，所以叫依赖。依赖注入：将实际值传递到变量中</p>
<p>常用注入方法为set注入，成员变量必须要有set方法才能注入</p>
<p><img src="/2019/12/22/springIoc/15.png" alt></p>
<p><img src="/2019/12/22/springIoc/16.png" alt></p>
<p><img src="/2019/12/22/springIoc/17.png" alt></p>
<p>因为依赖是在具体的类中，所以配置是在<bean>标签中，<strong>告诉spring容器，创建这个类的时候这些变量应该是什么值</strong>，其中name属性是指定变量的名称，准确说是指定set方法后面的名称，如setName()和setname()两个方法的name属性值分别是Name和name,<strong>注意不是成员变量名字，虽然大多数情况下都相同</strong></bean></p>
<p>value属性表示希望注入的值，<strong>注意由于value后面都是有双引号，所以值的类型都是字符串</strong>如age是Integer类型的变量，但是注入是“18”spring会自动进行类型转换，将字符串类型转换为其他所有能够转换的类型。value只能提供基本类型和string类型的数据</p>
<p>ref属性表示引用容器中其他的类，值为其他bean的id</p>
<h3 id="注解配置"><a href="#注解配置" class="headerlink" title="注解配置"></a>注解配置</h3><p>注解的分类：</p>
<ol>
<li>用于创建对象 和<bean>功能一样</bean></li>
<li>用于注入数据 和<property>功能一样，<strong>但是注解注入就不需要set方法</strong></property></li>
<li>用于改变作用范围 和<scop>功能一样</scop></li>
<li>和生命周期相关 和<init-method>功能一样</init-method></li>
</ol>
<p>首先启用注解功能需要导入约束</p>
<p><img src="/2019/12/22/springIoc/18.png" alt></p>
<p>context就是注解的约束，注意选中部分也是要导入的，一个功能有两份地址“context”和“xsd”</p>
<p>使用注解要在文件中配置</p>
<p><img src="/2019/12/22/springIoc/19.png" alt></p>
<p>告诉spring表示扫描的包</p>
<ol>
<li>创建对象的注解</li>
</ol>
<p><img src="/2019/12/22/springIoc/20.png" alt></p>
<p>表示以反射创建该对象（默认构造方法，也就是空参）并以首字母小写为id存入容器中，可以以该id取出来。</p>
<p>注解中如果只有一个value属性则该value属性可以不写，直接写值，比如“accountService”表示通过反射创建该类并以accountService为id存入容器中</p>
<ol start="2">
<li>依赖注入的注解</li>
</ol>
<p>有两种：@Autowired和@value前者只能注入容器中已存在的bean，后者可以注入基本类型和string，而且是从文件中读取</p>
<p>@Autowired表示只以<strong>类型</strong>在容器中查找相同类的对象并赋值给该变量</p>
<p><img src="/2019/12/22/springIoc/21.png" alt></p>
<p>自动找AccountDao类的对象，<strong>注意实现了AccountDao接口的对象也算是该类</strong>，所以可能会有多个，如果找到多个，则根据变量名决定，如果容器中有id为accountDao的对象则注入。<strong>所以使用注解注入不需要set方法</strong></p>
<p><img src="/2019/12/22/springIoc/22.png" alt></p>
<p><img src="/2019/12/22/springIoc/23.png" alt></p>
<p>value注入直接在属性中写入值即可注入，但是只能是基本类型和string类型，由于Date类型不是基本类型，所以无法通过value注入</p>
<p><img src="/2019/12/22/springIoc/24.png" alt></p>
<p><img src="/2019/12/22/springIoc/25.png" alt></p>
<p>Date可以这样注入创建到容器中，再通过Aurowired取出</p>
<h3 id="Spring中的junit测试"><a href="#Spring中的junit测试" class="headerlink" title="Spring中的junit测试"></a>Spring中的junit测试</h3><p>原本junit测试中集成了一个main方法，在该main方法中会判断当前测试类中哪些方法会有@test注解，junit就会让其执行，但junit不会管我们用的什么框架，也就不会加载spring容器，所以要整合spring和junit</p>
<ol>
<li>导入整合后的包</li>
</ol>
<p><img src="/2019/12/22/springIoc/26.png" alt></p>
<ol start="2">
<li>替换当前junit运行环境，把原来junit本身的main方法替换成spring提供的，run注解就是替换运行期</li>
</ol>
<p><img src="/2019/12/22/springIoc/27.png" alt></p>
<ol start="3">
<li>告知spring的运行器，是基于注解还是xml配置的，并说明位置</li>
</ol>
<p><img src="/2019/12/22/springIoc/28.png" alt></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/11/iterm2%E5%BF%AB%E6%8D%B7%E7%99%BB%E9%99%86%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/blogImg/6711866_014214_8838.jpg">
      <meta itemprop="name" content="XXX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/11/iterm2%E5%BF%AB%E6%8D%B7%E7%99%BB%E9%99%86%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="post-title-link" itemprop="url">iterm2快捷登陆远程服务器</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-11 15:45:11" itemprop="dateCreated datePublished" datetime="2019-12-11T15:45:11+08:00">2019-12-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-01-23 23:16:50" itemprop="dateModified" datetime="2020-01-23T23:16:50+08:00">2020-01-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="正常使用ssh登陆服务器"><a href="#正常使用ssh登陆服务器" class="headerlink" title="正常使用ssh登陆服务器"></a>正常使用ssh登陆服务器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh -p port user@host</span><br><span class="line"></span><br><span class="line">user@host&apos;s password:</span><br></pre></td></tr></table></figure>

<p>整个ssh登陆过程：</p>
<ol>
<li>用户向远程主机发送登陆请求：ssh user@host</li>
<li>远程主机收到用户请求，<strong>把自己的公钥发送给用户</strong></li>
<li>用户使用这个公钥，<strong>将登陆密码加密</strong>，发送回远程主机</li>
<li>远程主机使用自己的私钥，解密登陆密码，如果密码正确，就同意用户登陆</li>
</ol>
<p>在linux上，如果是第一次登陆远程主机，会出现如下：</p>
<p></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ssh user@host </span><br><span class="line">The authenticity of host &apos;host (12.18.429.21)&apos; can&apos;t be established. </span><br><span class="line">RSA key fingerprint is 98:2e:d7:e0:de:9f:ac:67:28:c2:42:2d:37:16:58:4d. </span><br><span class="line">Are you sure you want to continue connecting (yes/no)?</span><br></pre></td></tr></table></figure>

<p>这段话的意思是：无法确认host主机的真实性，只知道它的公钥指纹，问你还想继续连接吗</p>
<blockquote>
<p>很自然的一个问题就是，用户怎么知道远程主机的公钥指纹应该是多少？回答是没有好办法，远程主机必须在自己的网站上贴出公钥指纹，以便用户自行核对。</p>
</blockquote>
<p>所谓”公钥指纹”，是指公钥长度较长（这里采用RSA算法，长达1024位），很难比对，所以对其进行MD5计算，将它变成一个128位的指纹。上例中是98:2e:d7:e0🇩🇪9f:ac:67:28:c2:42:2d:37:16:58:4d，再进行比较，就容易多了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br></pre></td></tr></table></figure>

<p>系统会出现一句提示，表示host主机已经得到认可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Warning: Permanently added &apos;host,12.18.429.21&apos; (RSA) to the list of known hosts.</span><br></pre></td></tr></table></figure>

<p>然后输入密码，如果正确就可以登陆</p>
<p>当远程主机的公钥被接受以后，它就会被保存在文件  $HOME/.ssh/known_hosts之中。下次再连接这台主机，系统就会认出它的公钥已经保存在本地了，从而跳过警告部分，直接提示输入密码。<br>每个SSH用户都有自己的known_hosts文件，分别在自己的$HOME目录下，此外操作系统也有一个这样的文件，通常是/etc/ssh/ssh_known_hosts，保存一些对所有用户都可信赖的远程主机的公钥。</p>
<p>一句话：第一次连接成功后，远程主机的公钥就被保存在了本机，下次再连接就可以直接输入密码了</p>
<h3 id="使用iterm2-Profiles快捷登陆ssh"><a href="#使用iterm2-Profiles快捷登陆ssh" class="headerlink" title="使用iterm2 Profiles快捷登陆ssh"></a>使用iterm2 Profiles快捷登陆ssh</h3><p>找一个目录创建一个普通文件，在里面写入：</p>
<p><img src="/2019/12/11/iterm2%E5%BF%AB%E6%8D%B7%E7%99%BB%E9%99%86%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/1.png" alt></p>
<p>打开iterm2 -&gt; preferences -&gt; Profiles<br>点击下面“+”号，新建一个profile。<br>选择Command 在输入框中输入<br>expect+刚才建的文件路径</p>
<p><img src="/2019/12/11/iterm2%E5%BF%AB%E6%8D%B7%E7%99%BB%E9%99%86%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/2.png" alt></p>
<p><img src="/2019/12/11/iterm2%E5%BF%AB%E6%8D%B7%E7%99%BB%E9%99%86%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/3.png" alt></p>
<p>直接点击就可以登陆</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/07/maven/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/blogImg/6711866_014214_8838.jpg">
      <meta itemprop="name" content="XXX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/07/maven/" class="post-title-link" itemprop="url">maven</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-07 21:16:03" itemprop="dateCreated datePublished" datetime="2019-12-07T21:16:03+08:00">2019-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-11 15:35:14" itemprop="dateModified" datetime="2019-12-11T15:35:14+08:00">2019-12-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="为什么要用maven"><a href="#为什么要用maven" class="headerlink" title="为什么要用maven"></a>为什么要用maven</h3><p><img src="/2019/12/07/maven/1.png" alt></p>
<p>目前开发中存在的问题：</p>
<ol>
<li>一个项目就是一个工程<br>如果项目非常庞大，就不适合继续使用package来划分模块。最好是每一个模块对应一个项目，利于分工协作。<br>借助于maven就可以将一个项目拆分成多个工程。</li>
<li>项目中需要的jar包必须手动“复制”、”粘贴” 到WEB-INF/lib 项目下<br>带来的问题：同样的jar包文件重复出现在不同的项目工程中，一方面浪费存储空间，另外也让工程比较臃肿。<br>借助Maven，可以将jar包仅仅保存在“仓库”中，有需要使用的工程“引用”这个文件，并不需要重复复制。</li>
<li>jar包需要别人替我们准备好，或到官网下载<br>所有知名框架或第三方工具jar包已经按照统一规范放在了Maven的中央仓库中。</li>
<li>一个jar包依赖的其他jar包需要自己手动加到项目中<br>Maven会自动将被依赖的jar包导入进来。</li>
</ol>
<h3 id="maven是什么"><a href="#maven是什么" class="headerlink" title="maven是什么"></a>maven是什么</h3><ol>
<li>Maven 是 Apache 软件基金会组织维护的一款自动化构建工具，专注服务于 Java 平台的项目构建和依赖管理 。Maven 这个单词的本意是：专家，内行。读音是[‘meɪv(ə)n]或[‘mevn]。<br>构建工具的发展：Make→Ant→Maven→Gradle</li>
<li>构建：就是以我们编写的Java代码、框架配置文件、国际化等其他资源文件、jsp页面和图片等静态资源作为“原材料”，去“生产”出一个可以运行的项目的过程。</li>
</ol>
<p><img src="/2019/12/07/maven/2.png" alt></p>
<p>在web工程中主要有三个目录：src(存放源文件)、build(存放编译后的class文件)、WebContent(存放页面资源和配置的文件)。工程经过部署后就要在服务器上运行，也就是tomcat上，tomcat对部署的工程有严格的目录要求，对应关系是：<strong>工程名字就是运行的根目录，Chiken是工程名也是tomcat上应用的名字</strong>WebContent目录下的所有文件都会到应用到根目录下，其中build下的内容会到WEB-INF目录下，所谓的类路径说的就是编译后的class文件的路径，即：<strong>tomcat中WEB-INF=build+WEB-INF，应用根目录=WebContent</strong></p>
<p>总结：应用=WebContent+build 其中build到了WEB-INF中了，因为WEB-INF中的东西不能直接访问，为了安全所以class文件在其中</p>
<h4 id="构建的几个主要环节"><a href="#构建的几个主要环节" class="headerlink" title="构建的几个主要环节"></a>构建的几个主要环节</h4><p>①清理：删除以前的编译结果，为重新编译做好准备。<br>②编译：将Java源程序编译为字节码文件。<br>③测试：针对项目中的关键点进行测试，确保项目在迭代开发过程中关键点的正确性。<br>④报告：将每一次测试后以标准的格式记录和展示测试结果。<br>⑤打包：将一个包含诸多文件的工程封装为一个压缩文件用于安装或部署。Java工程对应jar包，Web工程对象war包。<br>⑥安装：在Maven环境下特指将打包的结果——Jar包或War包安装到本地仓库中。<br>⑦部署：将打包的结果部署到远程仓库或将war包部署到服务器上运行。</p>
<h3 id="maven工程"><a href="#maven工程" class="headerlink" title="maven工程"></a>maven工程</h3><p><img src="/2019/12/07/maven/3.png" alt></p>
<p>遵守约定的目录结构的意义</p>
<p>我们在开发中如果需要让第三方工具或框架知道我们自己创建的资源在哪，那么基本上就是两种方式：<br>①以配置文件的方式明确告诉框架 如 &lt; param-value&gt;classpath:spring-context.xml &lt; /param-value&gt;<br>②遵循框架内部已经存在的约定 如log4j的配置文件名规定必须为 log4j.properties 或 log4j.xml ；Maven 使用约定的目录结构</p>
<p>第三方：第一方是JDK、第二方是开发者、第三方是JDK和开发者都无法解决的东西需要其他包来完成</p>
<p>###maven常用命令</p>
<p>【1】mvn clean : 清理<br>【2】mvn compile : 编译主程序<br>【3】mvn test-compile : 编译测试程序<br>【4】mvn test : 执行测试<br>【5】mvn package : 打包<br>【6】mvn install ： 安装<br>【7】mvn site ：生成站点</p>
<ol>
<li>Maven 的核心程序中仅仅定义了抽象的生命周期，但是具体的工作必须有特定的插件来完成。而插件本身不包含在Maven核心程序中。</li>
<li>当我们执行的Maven命令需要用到某些插件时，Maven核心程序会首先到本地仓库中查找。</li>
<li>本地仓库的默认位置：[系统登陆用户的家目录] \ .m2\repository</li>
<li>Maven核心程序如果在本地仓库中找不到需要的插件，那么它会自动连接外网，到中央仓库下载。</li>
<li>如果此时无法连接外网，则构建失败。</li>
<li>修改默认本地仓库的位置可以让Maven核心程序到我们事先准备好的目录下查找插件<br>①找到Maven解压目录\conf\settings.xml<br>②在setting.xml 文件中找到 localRepository 标签<br>③将 &lt; localRepository&gt;/path/to/local/repo&lt; /localRepository&gt;从注释中取出<br>④将标签体内容修改为自定义的Maven仓库目录</li>
</ol>
<h3 id="POM"><a href="#POM" class="headerlink" title="POM"></a>POM</h3><ol>
<li>含义：Project Object Model 项目对象模型<br>DOM ：Document Object Model 文档对象模型</li>
<li>pom.xml 对于 Maven工程是核心配置文件，与构建过程相关的一切设置都在这个文件中进行配置。<br>重要程度相当于web.xml 对于动态web工程</li>
</ol>
<h3 id="坐标"><a href="#坐标" class="headerlink" title="坐标"></a>坐标</h3><ol>
<li><p>数学中的坐标：<br>①在平面中，使用X,Y坐标可以唯一的定位平面中任何一个点。<br>②在空间中，使用X,Y，Z三个向量可以唯一的定位空间中的任何一个点。</p>
</li>
<li><p>Maven的坐标：<br>使用下面三个向量在仓库中唯一定位一个Maven工程</p>
</li>
<li><p>①groupid:公司或组织域名倒序+项目名</p>
<blockquote>
<p>&lt; groupid&gt;com.atguigu.maven&lt; /groupid&gt;</p>
</blockquote>
<p>②artifactid:模块名</p>
<blockquote>
<p>&lt; artifactid&gt;Hello&lt; /artifactid&gt;</p>
</blockquote>
<p>③version：版本</p>
<blockquote>
<p>&lt; version&gt;1.0.0&lt; /version&gt;</p>
</blockquote>
<p>坐标又叫“gav”，全部是第一个首字母</p>
</li>
</ol>
<p>   Maven 工程的坐标与仓库中路径的对应关系，以spring为例</p>
<blockquote>
<p>&lt; groupId&gt;org.springframework&lt; /groupId&gt;<br>&lt; artifactId&gt;spring-core&lt; /artifactId&gt;<br>&lt; version&gt;4.0.0.RELEASE&lt; /version&gt;</p>
<p>org/springframework/spring-core/4.0.0.RELEASE/spring-core-4.0.0.RELEASE.jar</p>
</blockquote>
<p>全部一个一个拼起来就可以定位一个文件的位置，所以称作坐标</p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>当 A jar 包用到了 B jar 包中的某些类时，A 就对 B 产生了依赖，这是概念上的描述。Maven解析依赖信息时会到仓库中查找被依赖的jar包。<br>对于我们自己开发的Maven工程，要使用mvn install 命令安装后就可以进入仓库。</p>
<p><img src="/2019/12/07/maven/4.png" alt></p>
<h4 id="依赖的范围"><a href="#依赖的范围" class="headerlink" title="依赖的范围"></a>依赖的范围</h4><p><img src="/2019/12/07/maven/5.png" alt></p>
<p>compile范围的依赖主要在编译阶段有效，即主程序和测试程序都需要编译，所以都有效，有效的意思是：在源码中导入相应的包后可以使用</p>
<p>test范围的依赖只在测试阶段有效，即在主程序的源码中导包后并不能使用，提示没有相应的依赖</p>
<p>compile范围依赖<br>》对主程序是否有效：有效<br>》对测试程序是否有效：有效<br>》是否参与打包：参与<br>》是否参与部署：参与<br>》典型例子：spring-core</p>
<p>test范围依赖<br>》对主程序是否有效：无效<br>》对测试程序是否有效：有效<br>》是否参与打包：不参与<br>》是否参与部署：不参与<br>》典型例子：Junit</p>
<p>因为test的包不需要部署到服务器上，所以也不需要打包，打包的目的就是为了部署（编译测试打包安装部署运行）</p>
<p><img src="/2019/12/07/maven/6.png" alt></p>
<p>provided的依赖意思是：在开发阶段可以使用，打包和部署则由servlet容器提供</p>
<p>》对主程序是否有效：有效<br>》对测试程序是否有效：有效<br>》是否参与打包：不参与<br>》是否参与部署：不参与<br>》典型例子：Servlet-api.jar</p>
<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><ol>
<li>各个构建环节执行的顺序：不能打乱顺序，必须按照既定的正确顺序来执行。</li>
<li>Maven的核心程序中定义了抽象的生命周期，生命周期中各个阶段的具体任务是由插件来完成的。</li>
<li>Maven核心程序为了更好的实现自动化构建，按照这一特点执行生命周期中各个阶段：不论现在要执行生命周期中的哪一阶段，都是从这个生命周期最初的位置开始执行。</li>
<li>Maven有三套相互独立的生命周期，分别是：<br>①Clean Lifecycle 在进行真正的构建之前进行一些清理工作。<br>②Default Lifecycle 构建的核心部分，编译、测试、打包、安装、部署等等。<br>③Site Lifecycle 生成项目报告，站点，发布站点。</li>
</ol>
<p>他们相互独立。也可以直接运行 mvn clean install site 运行所有这三套生命周期。</p>
<p>每套生命周期都由一组阶段(Phase)组成，我们平时在命令行输入的命令总会对应于一个特定的阶段。比如，运行 mvn clean，这个 clean 是 Clean 生命周期的一个阶段。有 Clean 生命周期，也有 clean 阶段。</p>
<p>Default声明周期<br>Default 生命周期是 Maven 生命周期中最重要的一个，绝大部分工作都发生在这个生命周期中。这里，只解释一些比较重要和常用的阶段：<br>validate<br>generate-sources<br>process-sources<br>generate-resources<br>process-resources 复制并处理资源文件，至目标目录，准备打包。<br>compile 编译项目的源代码。<br>process-classes<br>generate-test-sources<br>process-test-sources<br>generate-test-resources<br>process-test-resources 复制并处理资源文件，至目标测试目录。<br>test-compile 编译测试源代码。<br>process-test-classes<br>test 使用合适的单元测试框架运行测试。这些测试代码不会被打包或部署。<br>prepare-package<br>package 接受编译好的代码，打包成可发布的格式，如 JAR。<br>pre-integration-test<br>integration-test<br>post-integration-test<br>verify<br>install 将包安装至本地仓库，以让其它项目依赖。<br>deploy 将最终的包复制到远程的仓库，以让其它开发人员与项目共享或部署到服务器上运行。</p>
<p><strong>总结：编译 测试 打包 安装 部署运行</strong></p>
<p>插件和目标<br>Maven的核心仅仅定义了抽象的生命周期，具体的任务都是交由插件完成的。<br>每个插件都实现多个功能，每个功能就是一个插件目标<br>Maven的生命周期与插件目标相互绑定，以完成某个具体的构建任务。<br>可以将目标看做“调用插件功能的命令”</p>
<p>例如：compile 就是插件 maven-compiler-plugin 的一个目标；pre-clean 是插件 maven-clean-plugin 的一个目标。</p>
<p>插件：目标（一个插件可以有多个目标）</p>
<h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>现状<br>Hello依赖的Junit：4.0<br>HelloFriend依赖的Junit：4.0<br>MakeFriends依赖的Junit：4.9</p>
<p>由于test范围的依赖不能传递，所以必然会分散在各个模块工程中，很容易造成版本不一致。</p>
<p>需求：统一管理各个模块工程中对Junit依赖的版本。</p>
<p>解决思路：将Junit依赖统一提取到“父”工程中，在子工程中声明Junit依赖是不指定版本，以父工程中统一设定的为准。同时也便于修改。</p>
<p>子工程依赖父工程，在子工程中删除不同的地方，也即是版本号，也就继承了父的版本号</p>
<h3 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h3><p>非聚合状态下是一个一个工程编译打包安装，但是聚合后就可以一键安装，指定聚合工程中包含的模块，然后只用在聚合工程上点击安装，其他模块都会自动安装。</p>
<p><img src="/2019/12/07/maven/7.png" alt></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/02/iterm2-oh-my-zsh%E6%9B%BF%E4%BB%A3mac%E7%BB%88%E7%AB%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/blogImg/6711866_014214_8838.jpg">
      <meta itemprop="name" content="XXX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/02/iterm2-oh-my-zsh%E6%9B%BF%E4%BB%A3mac%E7%BB%88%E7%AB%AF/" class="post-title-link" itemprop="url">iterm2+oh-my-zsh替代mac终端</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-02 21:09:34" itemprop="dateCreated datePublished" datetime="2019-12-02T21:09:34+08:00">2019-12-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-04 18:57:29" itemprop="dateModified" datetime="2019-12-04T18:57:29+08:00">2019-12-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="mac自带的终端"><a href="#mac自带的终端" class="headerlink" title="mac自带的终端"></a>mac自带的终端</h3><p>终端其实是一个与操作系统打交道的命令行界面，其中运行的程序叫shell（壳），之所以这么叫是因为操作系统就好比核心，我们不能直接与操作系统打交道，必须与shell交流通过它来操作系统。mac系统默认使用bash作为终端，通过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo $SHELL</span><br></pre></td></tr></table></figure>

<p>壳查看当前系统默认的shell，通过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/shells</span><br></pre></td></tr></table></figure>

<p>可查看系统所有存在的shell，所有的shell都存在于/etc/shell文件中，若要切换默认shell，可使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chsh -s /bin/zsh 或者 chsh -s /bin/bash</span><br></pre></td></tr></table></figure>

<h3 id="下载安装iterm2"><a href="#下载安装iterm2" class="headerlink" title="下载安装iterm2"></a>下载安装iterm2</h3><p>傻瓜式安装后即可使用，就是一个软件，和mac自带的终端一模一样，也是命令行，此时打开iterm2后默认的系统shell还是bash，可以使用以上命令查看，我们应该切换到zsh的shell，切换后界面和bash也是一样，我们还需要美化它，需要下载oh-my-zsh，直接在iterm2中输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># curl 安装方式</span><br><span class="line"></span><br><span class="line">sh -c &quot;$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)&quot;</span><br></pre></td></tr></table></figure>

<p>即可自动安装安装好后如图：</p>
<p><img src="/2019/12/02/iterm2-oh-my-zsh%E6%9B%BF%E4%BB%A3mac%E7%BB%88%E7%AB%AF/2411388-654b2a938885224c.png" alt></p>
<h3 id="修改iterm2到最佳外观"><a href="#修改iterm2到最佳外观" class="headerlink" title="修改iterm2到最佳外观"></a>修改iterm2到最佳外观</h3><p><img src="/2019/12/02/iterm2-oh-my-zsh%E6%9B%BF%E4%BB%A3mac%E7%BB%88%E7%AB%AF/1.png" alt="屏幕快照 2019-12-02 下午9.40.55"></p>
<p>设置为键盘左上角可显示/隐藏iterm2很方便</p>
<p><img src="/2019/12/02/iterm2-oh-my-zsh%E6%9B%BF%E4%BB%A3mac%E7%BB%88%E7%AB%AF/2.png" alt="屏幕快照 2019-12-02 下午9.44.26"></p>
<p>该设置可让外观好看，如下</p>
<p><img src="/2019/12/02/iterm2-oh-my-zsh%E6%9B%BF%E4%BB%A3mac%E7%BB%88%E7%AB%AF/3.png" alt="屏幕快照 2019-12-02 下午9.45.46"></p>
<p>若不喜欢打开后最上面显示上次的登陆信息，在～目录下可使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch .hushlogin</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="XXX"
    src="/assets/blogImg/6711866_014214_8838.jpg">
  <p class="site-author-name" itemprop="name">XXX</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">XXX</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.4.2
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  
















  

  

</body>
</html>
